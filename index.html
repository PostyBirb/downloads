<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="Download PostyBirb releases">
    <title>PostyBirb Downloads</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://avatars.githubusercontent.com/u/195112659?s=160" alt="PostyBirb Logo" class="logo">
            <h1>PostyBirb Downloads</h1>
            <p class="subtitle">Download the latest releases for all platforms</p>
        </div>
        
        <div class="main-content">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Loading releases...</p>
            </div>
            
            <div id="content" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            repos: [
                {
                    owner: 'mvdicarlo',
                    repo: 'postybirb-plus',
                    displayName: 'PostyBirb Plus',
                    filenameMappings: {
                        'PostyBirb\\+-{version}-universal\\.dmg': 'macOS Universal (DMG)',
                        'postybirb-plus-{version}-x86_64\\.AppImage': 'Linux (AppImage)',
                        'postybirb-plus-{version}\\.exe': 'Windows Portable (EXE)',
                        'postybirb-plus-setup-{version}\\.exe': 'Windows Installer'
                    }
                }
            ]
        };

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'dmg': 'üçé',
                'exe': 'ü™ü',
                'appimage': 'üêß',
                'deb': 'üì¶',
                'rpm': 'üì¶',
                'zip': 'üìÅ',
                'tar': 'üìÅ'
            };
            return icons[ext] || 'üìÑ';
        }

        function getReadableName(filename, mappings, version) {
            for (const [pattern, readableName] of Object.entries(mappings)) {
                const regex = new RegExp(pattern.replace('{version}', version.replace(/^v/, '')), 'i');
                if (regex.test(filename)) {
                    return readableName;
                }
            }
            return filename;
        }

        // GitHub API functions
        async function fetchReleases(owner, repo, count = 4) {
            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/releases?per_page=${count}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`Error fetching releases for ${owner}/${repo}:`, error);
                throw error;
            }
        }

        // Render functions
        function renderDownloads(releases, config) {
            return releases.map(release => {
                const assets = release.assets.filter(asset => 
                    !asset.name.includes('.blockmap') && 
                    !asset.name.includes('.sig') &&
                    !asset.name.endsWith('.yml') &&
                    !asset.name.endsWith('.yaml') &&
                    !asset.name.endsWith('.zip') &&
                    asset.size > 0
                );

                if (assets.length === 0) return '';

                const downloadsHtml = assets.map(asset => {
                    const readableName = getReadableName(asset.name, config.filenameMappings, release.tag_name);
                    const icon = getFileIcon(asset.name);
                    
                    return `
                        <li class="download-item">
                            <a href="${asset.browser_download_url}" class="download-button" target="_blank" rel="noopener">
                                <div class="download-info">
                                    <span class="download-icon">${icon}</span>
                                    <div>
                                        <div class="download-name">${readableName}</div>
                                        <div class="download-size">${formatFileSize(asset.size)}</div>
                                    </div>
                                </div>
                                <span>‚¨áÔ∏è</span>
                            </a>
                        </li>
                    `;
                }).join('');

                return `
                    <div class="release-card">
                        <div class="release-header">
                            <h3 class="release-version">${release.tag_name}</h3>
                            <p class="release-date">${formatDate(release.published_at)}</p>
                        </div>
                        <ul class="downloads-list">
                            ${downloadsHtml}
                        </ul>
                    </div>
                `;
            }).join('');
        }

        function renderRepo(repoConfig, releases) {
            const releasesHtml = renderDownloads(releases, repoConfig);
            
            return `
                <div class="repo-section">
                    <h2 class="repo-title">${repoConfig.displayName}</h2>
                    <div class="releases-grid">
                        ${releasesHtml}
                    </div>
                </div>
            `;
        }

        // Main function
        async function loadDownloads() {
            const loadingEl = document.getElementById('loading');
            const contentEl = document.getElementById('content');

            try {
                let allContent = '';

                for (const repoConfig of CONFIG.repos) {
                    try {
                        const releases = await fetchReleases(repoConfig.owner, repoConfig.repo, 4);
                        allContent += renderRepo(repoConfig, releases);
                    } catch (error) {
                        allContent += `
                            <div class="error">
                                <h3>Error loading ${repoConfig.displayName}</h3>
                                <p>Could not fetch releases. Please try again later.</p>
                            </div>
                        `;
                    }
                }

                contentEl.innerHTML = allContent;
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';

            } catch (error) {
                console.error('Error loading downloads:', error);
                contentEl.innerHTML = `
                    <div class="error">
                        <h3>Error Loading Downloads</h3>
                        <p>Please check your internet connection and try refreshing the page.</p>
                    </div>
                `;
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', loadDownloads);
    </script>
</body>
</html>