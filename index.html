<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="Download the latest PostyBirb releases for Windows, macOS, and Linux.">
    <meta name="keywords" content="PostyBirb, download, social media, Windows, macOS, Linux, app, release">
    <meta name="author" content="PostyBirb">
    <meta property="og:title" content="PostyBirb Downloads">
    <meta property="og:description" content="Download the latest PostyBirb releases for all platforms">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://avatars.githubusercontent.com/u/195112659?s=160">
    <title>PostyBirb Downloads - Latest Releases for All Platforms</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="https://avatars.githubusercontent.com/u/195112659?s=32">
</head>
<body>
    <div class="container">
        <header class="header">
            <img src="https://avatars.githubusercontent.com/u/195112659?s=160" alt="PostyBirb Logo" class="logo">
            <h1>PostyBirb Downloads</h1>
            <p class="subtitle">Download the latest releases for all platforms</p>
        </header>
        
        <main class="main-content">
            <div id="loading" class="loading" role="status" aria-label="Loading releases">
                <div class="spinner"></div>
                <p>Loading releases...</p>
            </div>
            
            <div id="content" style="display: none;" role="main"></div>
            
            <div id="error-state" class="error-state" style="display: none;" role="alert">
                <h3>Unable to Load Releases</h3>
                <p>Please check your internet connection and try again.</p>
                <button class="retry-button" onclick="loadDownloads()">Retry</button>
            </div>
        </main>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            repos: [
                {
                    owner: 'mvdicarlo',
                    repo: 'postybirb-plus',
                    displayName: 'PostyBirb Plus',
                    minVersion: null, // Set to a version string like "v3.0.0" to filter out older releases
                    filenameMappings: {
                        'PostyBirb\\+-{version}-universal\\.dmg': {
                            name: 'macOS Universal (DMG)',
                            os: 'macos',
                            osVersions: ['10.15+'],
                            recommended: true
                        },
                        'postybirb-plus-{version}-x86_64\\.AppImage': {
                            name: 'Linux (AppImage)',
                            os: 'linux',
                            distros: ['Universal'],
                            recommended: true
                        },
                        'postybirb-plus-{version}\\.exe': {
                            name: 'Windows Portable (EXE)',
                            os: 'windows',
                            osVersions: ['7+'],
                            recommended: false
                        },
                        'postybirb-plus-setup-{version}\\.exe': {
                            name: 'Windows Installer',
                            os: 'windows',
                            osVersions: ['7+'],
                            recommended: true
                        }
                    }
                }
            ]
        };

        // Utility functions
        function compareVersions(version1, version2) {
            // Remove 'v' prefix if present and split by dots
            const v1 = version1.replace(/^v/, '').split('.').map(num => parseInt(num) || 0);
            const v2 = version2.replace(/^v/, '').split('.').map(num => parseInt(num) || 0);
            
            // Pad arrays to same length
            const maxLength = Math.max(v1.length, v2.length);
            while (v1.length < maxLength) v1.push(0);
            while (v2.length < maxLength) v2.push(0);
            
            // Compare each part
            for (let i = 0; i < maxLength; i++) {
                if (v1[i] > v2[i]) return 1;
                if (v1[i] < v2[i]) return -1;
            }
            return 0;
        }

        function isVersionAtLeastMinimum(version, minVersion) {
            if (!minVersion) return true;
            return compareVersions(version, minVersion) >= 0;
        }

        function detectOS() {
            const userAgent = navigator.userAgent.toLowerCase();
            const platform = navigator.platform.toLowerCase();
            
            if (platform.includes('mac') || userAgent.includes('mac')) {
                return 'macos';
            } else if (platform.includes('win') || userAgent.includes('win')) {
                return 'windows';
            } else if (platform.includes('linux') || userAgent.includes('linux') || userAgent.includes('x11')) {
                return 'linux';
            }
            
            return 'unknown';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'dmg': '🍎',
                'exe': '🪟',
                'appimage': '🐧',
                'deb': '📦',
                'rpm': '📦',
                'zip': '📁',
                'tar': '📁'
            };
            return icons[ext] || '📄';
        }

        function getReadableName(filename, mappings, version) {
            for (const [pattern, config] of Object.entries(mappings)) {
                const regex = new RegExp(pattern.replace('{version}', version.replace(/^v/, '')), 'i');
                if (regex.test(filename)) {
                    return config;
                }
            }
            return { name: filename, os: 'unknown', recommended: false };
        }

        function isCompatibleWithCurrentOS(downloadConfig, currentOS) {
            return downloadConfig.os === currentOS || downloadConfig.os === 'unknown';
        }

        function formatOSInfo(downloadConfig) {
            let info = [];
            
            if (downloadConfig.osVersions && downloadConfig.osVersions.length > 0) {
                info.push(`${downloadConfig.osVersions.join(', ')}`);
            }
            
            if (downloadConfig.distros && downloadConfig.distros.length > 0) {
                info.push(`${downloadConfig.distros.join(', ')}`);
            }
            
            return info.length > 0 ? info.join(' • ') : '';
        }

        async function copyToClipboard(text, buttonElement) {
            try {
                await navigator.clipboard.writeText(text);
                const originalText = buttonElement.textContent;
                buttonElement.textContent = '✓ Copied!';
                buttonElement.style.background = '#28a745';
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.style.background = '';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy: ', err);
            }
        }

        function formatDownloadCount(count) {
            if (count >= 1000000) {
                return (count / 1000000).toFixed(1) + 'M';
            } else if (count >= 1000) {
                return (count / 1000).toFixed(1) + 'K';
            }
            return count.toString();
        }

        // GitHub API functions
        async function fetchReleases(owner, repo, config, count = 20) {
            try {
                // Fetch more releases than needed in case we need to filter by version
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/releases?per_page=${count}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                let releases = await response.json();
                
                // Filter releases by minimum version if specified
                if (config.minVersion) {
                    releases = releases.filter(release => 
                        isVersionAtLeastMinimum(release.tag_name, config.minVersion)
                    );
                }
                
                // Return only the first 4 after filtering
                return releases.slice(0, 4);
            } catch (error) {
                console.error(`Error fetching releases for ${owner}/${repo}:`, error);
                throw error;
            }
        }

        // Render functions
        function renderDownloads(releases, config) {
            const currentOS = detectOS();
            
            return releases.map((release, index) => {
                const assets = release.assets.filter(asset => 
                    !asset.name.includes('.blockmap') && 
                    !asset.name.includes('.sig') &&
                    !asset.name.endsWith('.yml') &&
                    !asset.name.endsWith('.yaml') &&
                    !asset.name.endsWith('.zip') &&
                    asset.size > 0
                );

                if (assets.length === 0) return '';

                // Sort assets to show compatible ones first
                const sortedAssets = assets.sort((a, b) => {
                    const aConfig = getReadableName(a.name, config.filenameMappings, release.tag_name);
                    const bConfig = getReadableName(b.name, config.filenameMappings, release.tag_name);
                    
                    const aCompatible = isCompatibleWithCurrentOS(aConfig, currentOS);
                    const bCompatible = isCompatibleWithCurrentOS(bConfig, currentOS);
                    
                    if (aCompatible && !bCompatible) return -1;
                    if (!aCompatible && bCompatible) return 1;
                    
                    // Among compatible downloads, prioritize recommended ones
                    if (aCompatible && bCompatible) {
                        if (aConfig.recommended && !bConfig.recommended) return -1;
                        if (!aConfig.recommended && bConfig.recommended) return 1;
                    }
                    
                    return 0;
                });

                const downloadsHtml = sortedAssets.map(asset => {
                    const downloadConfig = getReadableName(asset.name, config.filenameMappings, release.tag_name);
                    const icon = getFileIcon(asset.name);
                    const isCompatible = isCompatibleWithCurrentOS(downloadConfig, currentOS);
                    const osInfo = formatOSInfo(downloadConfig);
                    const downloadCount = asset.download_count ? formatDownloadCount(asset.download_count) : '';
                    
                    const classes = ['download-button'];
                    if (isCompatible) classes.push('compatible');
                    if (downloadConfig.recommended && isCompatible) classes.push('recommended');
                    
                    const ariaLabel = `Download ${downloadConfig.name} for ${downloadConfig.os}, ${formatFileSize(asset.size)}${isCompatible ? ', recommended for your system' : ''}`;
                    
                    return `
                        <li class="download-item">
                            <div class="download-wrapper">
                                <a href="${asset.browser_download_url}" 
                                   class="${classes.join(' ')}" 
                                   target="_blank" 
                                   rel="noopener"
                                   aria-label="${ariaLabel}"
                                   data-download-name="${downloadConfig.name}">
                                    <div class="download-info">
                                        <span class="download-icon" aria-hidden="true">${icon}</span>
                                        <div class="download-text">
                                            <div class="download-name">
                                                ${downloadConfig.name}
                                                ${downloadConfig.recommended && isCompatible ? '<span class="sr-only"> (Recommended)</span>' : ''}
                                            </div>
                                            <div class="download-details">
                                                <span class="download-size">${formatFileSize(asset.size)}</span>
                                                ${downloadCount ? `<span class="download-count">${downloadCount} downloads</span>` : ''}
                                                ${osInfo ? `<span class="os-info">${osInfo}</span>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <span class="download-arrow" aria-hidden="true">⬇️</span>
                                </a>
                                <button class="copy-link-btn" 
                                        onclick="copyToClipboard('${asset.browser_download_url}', this)"
                                        aria-label="Copy download link to clipboard"
                                        title="Copy download link">
                                    📋
                                </button>
                            </div>
                        </li>
                    `;
                }).join('');

                return `
                    <article class="release-card${index === 0 ? ' latest-release' : ''}" 
                             itemscope itemtype="https://schema.org/SoftwareApplication">
                        <header class="release-header">
                            <div class="release-title-container">
                                <h3 class="release-version" itemprop="version">${release.tag_name}</h3>
                                ${index === 0 ? '<span class="latest-badge" aria-label="Latest release">Latest</span>' : ''}
                            </div>
                            <time class="release-date" datetime="${release.published_at}" itemprop="datePublished">
                                ${formatDate(release.published_at)}
                            </time>
                        </header>
                        <div class="downloads-section">
                            <h4 class="downloads-title sr-only">Available downloads for ${release.tag_name}</h4>
                            <ul class="downloads-list" role="list">
                                ${downloadsHtml}
                            </ul>
                        </div>
                        ${release.body ? `<details class="release-notes">
                            <summary>Release Notes</summary>
                            <div class="release-notes-content">${release.body.substring(0, 300)}${release.body.length > 300 ? '...' : ''}</div>
                        </details>` : ''}
                    </article>
                `;
            }).join('');
        }

        function renderRepo(repoConfig, releases) {
            const releasesHtml = renderDownloads(releases, repoConfig);
            const githubUrl = `https://github.com/${repoConfig.owner}/${repoConfig.repo}/releases`;
            
            return `
                <div class="repo-section">
                    <div class="repo-header">
                        <h2 class="repo-title">${repoConfig.displayName}</h2>
                        <a href="${githubUrl}" class="github-link" target="_blank" rel="noopener">
                            <span class="github-icon">📦</span>
                            View all releases on GitHub
                        </a>
                    </div>
                    <div class="releases-grid">
                        ${releasesHtml}
                    </div>
                </div>
            `;
        }

        // Main function
        async function loadDownloads() {
            const loadingEl = document.getElementById('loading');
            const contentEl = document.getElementById('content');
            const errorEl = document.getElementById('error-state');

            // Show loading state
            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
            errorEl.style.display = 'none';

            try {
                let allContent = '';
                let hasContent = false;

                for (const repoConfig of CONFIG.repos) {
                    try {
                        const releases = await fetchReleases(repoConfig.owner, repoConfig.repo, repoConfig);
                        if (releases.length > 0) {
                            allContent += renderRepo(repoConfig, releases);
                            hasContent = true;
                        }
                    } catch (error) {
                        console.error(`Error loading ${repoConfig.displayName}:`, error);
                        allContent += `
                            <div class="repo-error" role="alert">
                                <h3>Error loading ${repoConfig.displayName}</h3>
                                <p>Could not fetch releases. This might be due to rate limiting or network issues.</p>
                                <details class="error-details">
                                    <summary>Technical details</summary>
                                    <code>${error.message}</code>
                                </details>
                            </div>
                        `;
                    }
                }

                if (hasContent) {
                    contentEl.innerHTML = allContent;
                    loadingEl.style.display = 'none';
                    contentEl.style.display = 'block';
                } else {
                    throw new Error('No releases could be loaded');
                }

            } catch (error) {
                console.error('Error loading downloads:', error);
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', loadDownloads);
    </script>
</body>
</html>